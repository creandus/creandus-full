#!/bin/bash
# Copyright 2006 Mike Kelly
# Distributed under the terms of the GNU General Public License v2
#
# adduser.bash - intelligently adds a new user for the system package
# manager.
#
# $Id$

prefix=@prefix@
datarootdir=@datarootdir@
scriptdir=${SCRIPTDIR:-@datadir@/@PACKAGE@}

# Load the basic configuration.
. "${scriptdir}/common/config.bash"
. "${scriptdir}/common/functions.bash"

main() {
	# Read the command line arguments.

	# The only options recognized now are the user to be added, the 
	# package which is asking for the adding, and the userspace type (e.g. 
	# GNU, fbsd, etc)
	NEWUSER=${1}
	PKGNAME=${2}
	USERSPACE=${3}
	ROOT=${4}

	if [[ -z "${NEWUSER}" || -z "${PKGNAME}" || -z "${USERSPACE}" \
	|| -z "${ROOT}" ]] ; then
		echo "Script expects 4 arguments: username pkgname userspace root" >&2
		exit 1
	fi

	# Set our default action. Will be either "add" or "mod" by the end.
	ACTION="add"

	###

	# Read the proper data file for the desired user
	. "${scriptdir}/common/read_userdata.bash"

	# Determine a free uid
	# We make use of egetent:
	. "${scriptdir}/common/getent.bash"

	# TODO: allow for more sophisticated range specifications
	uidmin=${userid%-*}
	uidmax=${userid#*-}

	userid=${usermin}
	for i in $( seq ${userid} ${uidmax} ) ; do
		[[ -z $(egetent passwd ${i}) ]] && userid=${i} && break
	done

	# Now, we verify this information against our database, and if there
	# isn't a match (either some value has changed, or there is no entry
	# at all), we take appropriate action

	# See if the user already exists
	if [[ ${NEWUSER} == $(egetent passwd "${NEWUSER}" | cut -d: -f1) ]]
	then
		# TODO: If there needs to be some change made, note it
		# properly, for the user to take care of later with
		# the eselect tool
		getentinfo=$(egetent passwd "${NEWUSER}")
		
		curruid=$(echo ${getentinfo} | cut -d: -f3)
		currshell=$(echo ${getentinfo} |cut -d: -f7)
		currhome=$(echo ${getentinfo} |cut -d: -f6)
		# TODO: Check that the user is in all the proper groups here
		currcomment=$(echo ${getentinfo} |cut -d: -f5)
		if [[ ${curruid} -ne ${userid} 
		|| "${currshell}" != "${usershell}"
		|| "${currhome}" != "${userhome}"
		|| "${currcomment}" != "${usercomment}" ]] ; then
			echo "The user ${NEWUSER} needs some values changed."
			echo "We're doing so now."
			ACTION="mod"
		else
			# Now, since we've made the proper arrangements for any 
			# possible changes, we now add the current package name 
			# to the database and call it quits
			echo -n "We already have a user named ${NEWUSER}." >&2
			echo " Nothing to do." >&2

			echo "${PKGNAME}" >> "${DBDIR}/user/${NEWUSER}"
			exit 0
		fi
	fi

	if [[ -f "${DBDIR}/user/${NEWUSER}" ]] ; then
		echo "User ${NEWUSER} was previously added by this script," \
			"but it no longer exists" 1>&2
		echo "on the system. We'll re-add them now, but you should" \
			"have used the" 1>&2
		echo "users-config tool to cleanly remove them." 1>&2
	fi

	# Finally, we take take the necessary action, either via usermod 
	# or useradd [or it's comparable friends]
	for x in ${PASSWD_BACKENDS}; do
		if [[ -e "${scriptdir}/auth/${x}-${USERSPACE}-user${ACTION}.bash" ]] 
		then
			echo "Running ${x}-${USERSPACE}-user${ACTION}..."
			. "${scriptdir}/auth/${x}-${USERSPACE}-user${ACTION}.bash"
		else
			echo "Auth backend ${x} with userspace ${USERSPACE}" \
			"not supported by this script." 1>&2
		fi
	done

	# Properly update the dynamic users database
	"${scriptdir}/db.bash" add user "${PKGNAME}" "${NEWUSER}"
}

if [[ "${1}" == "--test" ]] ; then
	echo "Syntax OK."
	exit 0
fi

main $@
