# Copyright 2006 Mike Kelly
# Distributed under the terms of the GNU General Public License v2
#
# read_userdata.sh - Read the proper data file for the desired user
# $Id$

# In the full implementation, should go through all the cascading
# profiles in proper order, but for now we're just parsing these 2
# config files

# TODO: Build USERFILE dynamically based upon the currently selected profile.
# Work from the profile up to its parents, etc, to build this list.

# TODO: Split this file up in such a way as to be automatically done
# correctly for various distros.

# read_userdata()
# Inputs:
#  $1 - name of user to be added
# Outputs:
#  $userid - a range specification of valid user ids for the given user name
#  $usershell - the user's default shell
#  $userhome - the users's home directory
#  $usergroups - a comma-separated list of groups the user belongs to
#  $usercomment - the GECOS comment field for the user
read_userdata() {
	local userfile="${DATADIR}/user/${1} ${DATADIR}/accounts"
	local userid userid_ usershell usershell_ userhome userhome_
	local usergroups usergroups_ usercomment usercomment_

	for x in ${USERFILE}; do
		userid_=$(grep ^uid: ${x} |cut -d: -f2)
		userid_=${userid_## }
		userid=${userid:-${userid_}}

		usershell_=$(grep ^shell: "${x}" |cut -d: -f2)
		usershell_=${usershell_## }
		usershell=${usershell:-${usershell_}}

		userhome_=$(grep ^home: "${x}" |cut -d: -f2)
		userhome_=${userhome_## }
		userhome=${userhome:-${userhome_}}

		usergroups_=$(grep ^groups: "${x}" |cut -d: -f2)
		usergroups_=${usergroups_## }
		usergroups=${usergroups:-${usergroups_}}

		usercomment_=$(grep ^comment: "${x}" |cut -d: -f2)
		usercomment_=${usercomment_## }
		usercomment=${usercomment:-${usercomment_}}
	done

	[[ -z "${userid}" ]] && die "Couldn't determine a uid range"
	echo "local userid=\"${userid}\""
	[[ -z "${usershell}" ]] && die "Couldn't determine a shell"
	echo "local usershell=\"${usershell}\""
	[[ -z "${userhome}" ]] && die "Couldn't determine a home dir"
	echo "local userhome=\"${userhome}\""
	[[ -z "${usergroups}" ]] && die "Couldn't determine any user groups"
	echo "local usergroups=\"${usergroups}\""
	[[ -z "${usercomment}" ]] && die "Couldn't determine a GECOS comment"
	echo "local usercomment=\"${usercomment}\""
}
# vim: ts=4 :
