#!/bin/bash
# Copyright 2006 Mike Kelly
# Distributed under the terms of the GNU General Public License v2
#
# Manage the dynusers database
#
# $Id$

prefix=@prefix@
datarootdir=@datarootdir@
scriptdir=${SCRIPTDIR:-@datadir@/@PACKAGE@}

# Load the basic configuration.
. "${scriptdir}/common/config.bash"
. "${scriptdir}/common/functions.bash"

main() {
	case "${1}" in
		add)
			# Read our remaining args
			# Options: [user|group] [pkgname] [newname]
			local dbtype="${2}" pkgname="${3}"
			local newname="${4}" userland="${5}"

			[[ -z "${dbtype}" || -z "${pkgname}" \
				|| -z "${newname}" ]] \
				&& die "Add action expects 3 arguments:" \
				"[user/group] [pkgname] [user/group name]"

			[[ "${dbtype}" != "user" || "${dbtype}" != "group" ]] \
				&& die "Invalid DBTYPE. Use user or group."

			echo "${pkgname}" >> "${DBDIR}/${dbtype}/${newname}"
			;;
		del)
			# Read our remaining args
			pkgname=${2}
	
			[[ -z "${pkgname}" ]] \
				&& die "Del option expects a package name."

			# Replace any /s with \/s so as to not mess up sed
			pkgname=${pkgname/\//\\/}

			# Remove only the first instance of pkgname from the 
			# db files
			sed -i /^${pkgname}\$/\{x\;/Y/\!\{s/^/Y/\;h\;d\}\;x\;\}\
				"${DBDIR}"/{user,group}/*
			;;
		*)
			die "Invalid action. Valid actions are add, del."
			;;
	esac
}

if [[ "${1}" == "--test" ]] ; then
	echo "Syntax OK."
	exit 0
fi

main $@
