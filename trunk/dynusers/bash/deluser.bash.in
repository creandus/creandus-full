#!/bin/bash
# Copyright 2006 Mike Kelly
# Distributed under the terms of the GNU General Public License v2
#
# Delete a user managed by the dynusers scripts.
#
# $Id$

SCRIPTDIR=${SCRIPTDIR:-@SCRIPTDIR@}

# Load the basic configuration
. "${SCRIPTDIR}/common/config.bash" || exit 1
. "${SCRIPTDIR}/common/functions.bash" || exit 1

main() {
	# Read the command line arguments.
	# Currently, we expect the following:
	local deaduser=${1} userspace=${2} root=${3:-/}
	# XXX: Make sure we verify our command line args here.

	# first, verify that the user to be deleted can be safely deleted
	[[ -s ${DBDIR}/user/${deaduser} ]] \
		&& die "Group ${deaduser} is still in use by some other" \
			"package. Not removing."

	for x in ${PASSWD_BACKENDS} ; do
		if [[ -e "${SCRIPTDIR}/auth/${x}-${userspace}-userdel.bash" ]]
		then
			echo "Running ${x}-${userspace}-userdel..."
			. "${SCRIPTDIR}/auth/${x}-${userspace}-userdel.bash"
			"${x}-${userspace}-userdel" "${deaduser}" "${root}" \
				|| die "userdel failed"
		else
			echo "Auth backend ${x} with userspace ${userspace}" \
				"not supported by this script." >&2
		fi
	done

	# Remove the empty database file
	rm ${DBDIR}/user/${deaduser}
}

if [[ "${1}" == "--test" ]] ; then
	echo "Syntax OK."
	exit 0
fi

main $@
# vim: ts=4 :
